# 評価値（ev）の計算方法

## 概要

評価値（`ev`）は、`player.eval_shoupai(shoupai, paishu, back)`メソッドによって計算されます。
このメソッドは、手牌の状態に応じて、将来の和了期待値を再帰的に計算します。

## 計算ロジック

### 1. 和了形の場合（n_xiangting == -1）

```javascript
rv = this.get_defen(shoupai);
```

- **評価値 = ツモ和了の和了打点**
- 和了形の場合は、その手牌でツモ和了した場合の打点をそのまま評価値とします
- 門前の場合は立直の1翻を加えますが、一発・裏ドラは考慮しません
- 積み場、供託も打点には加えません

### 2. 打牌可能な状態の場合（shoupai._zimo、手牌が14枚）

```javascript
for (let p of this.get_dapai(shoupai)) {
    let new_shoupai = shoupai.clone().dapai(p);
    if (Majiang.Util.xiangting(new_shoupai) > n_xiangting) continue;
    
    let ev = this.eval_shoupai(new_shoupai, paishu, back);
    if (ev > rv) rv = ev;
}
```

- **評価値 = 打牌後の最大評価値**
- ツモの後や副露の後など、打牌可能な状態の場合、すべての打牌候補を試します
- 向聴数が戻らない（悪化しない）打牌を行った後の牌姿の評価値のうち、最大のものをその牌姿の評価値とします
- シャンテン数が悪化する打牌は除外します

### 3. 打牌後の場合（手牌が13枚、テンパイもこの形、n_xiangting < 3）

```javascript
for (let p of add_hongpai(Majiang.Util.tingpai(shoupai))) {
    if (p == back) { rv = 0; break }
    if (paishu.val(p) == 0) continue;
    let new_shoupai = shoupai.clone().zimo(p);
    paishu.pop(p);
    
    let ev = this.eval_shoupai(new_shoupai, paishu, back);
    if (! back) {
        if (n_xiangting > 0)
            ev += this.eval_fulou(shoupai, p, paishu, back);
    }
    
    paishu.push(p);
    rv += ev * paishu.val(p);
}
rv /= width[n_xiangting];
```

- **評価値 = 向聴数の進む牌について、ツモった牌姿の評価値 × 牌の枚数 / マジックナンバー の総和**
- すべての待ち牌（向聴数の進む牌）について、その牌をツモした場合の評価値を計算
- 各待ち牌の評価値に、その牌の残り枚数を掛けて合計
- 最後に`width[n_xiangting]`で割る（正規化）
  - `width = [8, 8*4, 8*4*2] = [8, 32, 64]`
  - 0シャンテン（聴牌）: 8で割る
  - 1シャンテン: 32で割る
  - 2シャンテン: 64で割る
  - 注: この数値は「マジックナンバー」と呼ばれ、ツモる確率を疑似するための値です（ブログ記事では古いバージョンで `[12, 72, 216]` が使われていましたが、現在のバージョンでは `[8, 32, 64]` に変更されています）
- シャンテン数が0より大きい場合、副露（ポン・チー）の可能性も考慮（`eval_fulou`）

### 4. シャンテン数が3以上の場合（n_xiangting >= 3）

```javascript
for (let p of add_hongpai(this.tingpai(shoupai))) {
    if (paishu.val(p, 1) == 0) continue;
    
    rv += paishu.val(p, 1) * (   p[2] == '+' ? 4
                                : p[2] == '-' ? 2
                                :               1  );
}
```

- **評価値 = 待ち牌の残り枚数の合計（副露の可能性を考慮）**
- シャンテン数が3以上の場合、計算時間がかかり過ぎるため、詳細な評価値計算は行いません
- 代わりに、待ちの広さ（待ち牌の残り枚数）だけで評価します
- 副露の可能性がある場合、重み付けを行います
  - チー可能（`+`）: 4倍
  - ポン可能（`-`）: 2倍
  - 通常: 1倍

## 重要なポイント

1. **再帰的計算**: 評価値は再帰的に計算されます。将来の手牌状態をシミュレートして、最終的な和了期待値を求めます。

2. **牌山の残り枚数を考慮**: `paishu`（牌山の残り枚数）を使用して、各牌がツモできる確率を考慮します。「牌の枚数 / マジックナンバー」でツモる確率を疑似しています。

3. **副露の可能性**: シャンテン数が0より大きい場合、ポン・チーの可能性も評価に含めます（`eval_fulou`）。

4. **キャッシュ**: 同じ手牌状態の評価値はキャッシュされ、再計算を避けます。

5. **バックトラック**: `back`パラメータにより、特定の牌をツモしない場合の評価も計算できます。

6. **計算時間の最適化**: シャンテン数が3以上の場合、詳細な評価値計算は行わず、待ちの広さだけで評価します。これにより計算時間を短縮しています。

## 評価値の意味

- **高い評価値**: 和了に近い、または和了期待値が高い手牌
- **低い評価値**: 和了に遠い、または和了期待値が低い手牌
- **評価値の単位**: 基本的には打点（点数）を基準としていますが、シャンテン数が3以上の場合、待ち牌の残り枚数で評価されます
- **注意**: ほぼ期待値と同義ですが、正確な確率を用いていないため、誤解を避けるために「評価値」と呼んでいます

## 参考

- `submodules/majiang-ai/lib/player.js` の `eval_shoupai` メソッド（528-579行目）
- `width` 定数: `[8, 32, 64]`（9行目）
- [何切る検討(0) 〜 打牌選択アルゴリズム - koba::blog](https://blog.kobalab.net/entry/2019/06/09/130640)
