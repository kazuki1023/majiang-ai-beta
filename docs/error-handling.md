# フロントエンド エラーハンドリング方針

## 概要

手牌分析など Mastra API を呼び出すフロントエンドで、発生しうるエラーの種類・検出方法・ユーザーへの見せ方・対応策を整理する。
実装タスクは [frontend-implementation-plan.md](./frontend-implementation-plan.md) の **2.5 エラーハンドリング** に対応する。

---

## 表示方法: react-toastify で一律

- **ライブラリ**: [react-toastify](https://www.npmjs.com/package/react-toastify) を使用する。
- **方針**: エラーは画面内の固定セクションではなく **Toast で一律に表示**する。ユーザーが操作を続けつつ、非侵襲的に通知できる。
- **実装**: ルートレイアウト（または `_app` / レイアウト）に `<ToastContainer />` を置き、API 呼び出しや catch で `toast.error(message)` を呼ぶ。

---

## エラーの二分類

エラーを次の 2 種類に分け、**文言を統一**する。

| 分類 | 説明 | 表示するメッセージ方針 |
|------|------|------------------------|
| **ユーザーがどうすることもできない問題** | サーバー障害・ネットワーク・CORS・タイムアウトなど、ユーザーの操作では解消できないもの | 「時間をおいて再度実行してください」系の**一律メッセージ**で案内する。技術用語は出さない。 |
| **ユーザー起因の問題** | 入力不備（手牌形式の誤りなど）や 400 系でサーバーが理由を返してくれるもの | **解消方法が分かるメッセージ**を表示する。API から返ったメッセージがあればそれを活かし、なければ「入力内容を確認してください」等の具体的な案内にする。 |

実装時は、発生したエラーを上記どちらかに分類し、分類に応じたメッセージを `toast.error(...)` に渡す。

**文言の対応一覧**

| 分類 | 該当するエラー | Toast で使うメッセージ |
|------|----------------|-------------------------|
| ユーザーがどうすることもできない | ネットワーク、5xx、CORS、タイムアウト、ストリーム途中失敗、その他 | 「…時間をおいて再度実行してください。」で終わる一律メッセージ |
| ユーザー起因 | 4xx | API から返ったメッセージ（解消方法が分かるもの）。無い場合は「入力内容を確認してください」系 |
| Toast に出さない | ユーザーによるキャンセル（AbortError） | 結果末尾に「[キャンセルされました]」のみ |

---

## 前提

- **呼び出し形態**: ブラウザは同一オリジンの `POST /api/chat` を呼ぶ（Next が Mastra にプロキシ）。チャットは AI SDK の `useChat` で送受信する。
- **現状**: `page.tsx` で useChat の `error` を表示。キャンセルは `stop()`。エラー時は useChat が `error` をセットし、`error.message` を表示する。
- **未整備**: ネットワークエラー・CORS・タイムアウト・API のエラー body 形式の違いを区別していない。

---

## エラーの種類と検出・表示・対応

### 1. ネットワークエラー（fetch 失敗）

| 項目 | 内容 |
|------|------|
| **分類** | ユーザーがどうすることもできない問題 |
| **原因** | オフライン、DNS 失敗、接続拒否、サーバー未起動 など |
| **検出** | `fetch()` が reject する（TypeError: Failed to fetch 等）。`res.ok` の前に発生。 |
| **Toast で表示するメッセージ** | 「接続できませんでした。時間をおいて再度実行してください。」 |
| **見せ方** | `toast.error(...)` で表示。 |

**補足**: `err instanceof TypeError` や `err.message` が "Failed to fetch" を含むかで判別できることが多い。環境によって文言が変わるので、文言マッチは緩めにするか、「fetch が reject した＝ネットワーク系」とみなす。

---

### 2. HTTP 4xx（クライアントエラー）

| 項目 | 内容 |
|------|------|
| **分類** | ユーザー起因の問題 |
| **原因** | 400 Bad Request（不正な body）、401/403（認証・認可）、404（エンドポイント違い） など |
| **検出** | `res.ok === false` かつ `res.status >= 400 && res.status < 500`。 |
| **Toast で表示するメッセージ** | **解消方法が分かるメッセージ**とする。サーバーから返った body のメッセージ（`error.message` / `message`）があればそれをそのまま表示。なければ「入力内容に誤りがあります。手牌やオプションを確認してください。」など、何を直せばよいか分かる文言にする。 |
| **見せ方** | `toast.error(...)` で表示。 |

**API body 形式のばらつき（懸念点 §6）**:
Mastra が `{ error: { message: "..." } }` や `{ message: "..." }` など複数形式を返す可能性がある。
→ フロントでは「body を JSON パースし、`error?.message` / `message` を優先して表示用文字列にする」という共通ロジックを 1 箇所（例: `lib/mastra-client.ts` または `lib/api-error.ts`）にまとめる。4xx の場合は取れたメッセージをそのまま Toast に渡し、取れない場合だけ「入力内容を確認してください」系の文言にフォールバックする。

---

### 3. HTTP 5xx（サーバーエラー）

| 項目 | 内容 |
|------|------|
| **分類** | ユーザーがどうすることもできない問題 |
| **原因** | 500 Internal Server Error、502/503（Cloud Run の過負荷・冷気起動） など |
| **検出** | `res.ok === false` かつ `res.status >= 500`。 |
| **Toast で表示するメッセージ** | 「サーバーで問題が発生しました。時間をおいて再度実行してください。」（body のメッセージは技術的になりがちなため、**一律この文言**でユーザーに案内する方針を推奨） |
| **見せ方** | `toast.error(...)` で表示。 |

---

### 4. CORS エラー

| 項目 | 内容 |
|------|------|
| **分類** | ユーザーがどうすることもできない問題 |
| **原因** | Mastra API が CORS ヘッダーを返していない、または許可オリジンにフロントのオリジンが含まれていない。 |
| **検出** | ブラウザが fetch をブロックするため、**レスポンスは返ってこない**。`catch` で取得できるのは「Failed to fetch」に近い一般的なネットワークエラー。ステータスコードや body は取得不可。 |
| **Toast で表示するメッセージ** | ネットワークエラーと区別できないため、**同じ文言**にする。「接続できませんでした。時間をおいて再度実行してください。」（ユーザーには CORS と出さない） |
| **見せ方** | `toast.error(...)` で表示。 |

**補足**: 開発者向けにはドキュメント（cors-strategy.md 等）で CORS 時の症状を書いておく。本番ではユーザーに技術用語を見せず、「時間をおいて再度実行してください」で統一する。

---

### 5. タイムアウト

| 項目 | 内容 |
|------|------|
| **分類** | ユーザーがどうすることもできない問題 |
| **原因** | API の処理が長時間かかり、ブラウザやプロキシでタイムアウトする。ストリーミングでは「最初の byte が返るまで」でタイムアウトすることもある。 |
| **検出** | `fetch` に `AbortController` + `setTimeout` で一定時間後に `abort()` すると、`AbortError` が throw される。現状の実装では**タイムアウト用の abort は行っていない**（ユーザーが「キャンセル」したときだけ abort）。 |
| **Toast で表示するメッセージ** | 「時間がかかりすぎています。時間をおいて再度実行してください。」 |
| **見せ方** | `toast.error(...)` で表示。 |

**補足**: タイムアウトを実装する場合は、ユーザー操作によるキャンセル（AbortError）と区別する必要がある（キャンセルは Toast に出さず、結果末尾に「[キャンセルされました]」のみ）。タイムアウト用の abort であることを示すフラグや専用 Error クラスで判別する。

---

### 6. ユーザーによるキャンセル（AbortError）

| 項目 | 内容 |
|------|------|
| **分類** | エラーとしては扱わない（ユーザー意図の操作） |
| **原因** | ユーザーが「キャンセル」ボタンを押した。 |
| **検出** | `err.name === "AbortError"`。 |
| **表示** | **Toast は出さない**。分析結果エリアの末尾に「[キャンセルされました]」と追記するだけ。 |
| **見せ方** | 結果テキストの末尾に追記。 |

---

### 7. ストリーミング中のエラー・不正なストリーム

| 項目 | 内容 |
|------|------|
| **分類** | ユーザーがどうすることもできない問題 |
| **原因** | ストリーム開始後にサーバー側でエラーが発生し、body が途中で切れる。または SSE/NDJSON の形式が期待と異なる。 |
| **検出** | `reader.read()` の reject、または `res.ok` は true だが途中でストリームが閉じる。 |
| **Toast で表示するメッセージ** | 「応答の取得中に問題が発生しました。時間をおいて再度実行してください。」 |
| **見せ方** | `toast.error(...)` で表示。分析結果エリアには、すでに受信したテキストを残すかどうかは実装方針次第（残す場合は「※ 応答が途中で終了しています」などの注釈を付けるとよい）。 |

---

### 8. その他（JSON パース失敗・body なし など）

| 項目 | 内容 |
|------|------|
| **分類** | ユーザーがどうすることもできない問題（原因が不明なため） |
| **原因** | 4xx/5xx の body が JSON でない、または想定外の形式。 |
| **検出** | `res.json()` や `res.text()` のあとパースに失敗する、または `error` / `message` が取れない。 |
| **Toast で表示するメッセージ** | 「問題が発生しました。時間をおいて再度実行してください。」 |
| **見せ方** | `toast.error(...)` で表示。開発時はコンソールに生 body を出すと原因調査しやすい。 |

---

## 表示場所・UI の考え方（react-toastify）

- **エラー表示**: すべて **Toast**（`toast.error(message)`）で行う。画面内の固定エラーセクションは設けず、`page.tsx` の `error` state によるインライン表示もやめ、Toast に統一する。
- **ToastContainer**: `app/layout.tsx` に `<ToastContainer />` を 1 つだけ配置。テーマ（dark 対応など）は react-toastify のオプションで調整する。
- **分析結果エリア**: 成功時は分析結果、キャンセル時は「…[キャンセルされました]」のみ（Toast は出さない）。ストリーミング途中失敗時は Toast で案内し、結果エリアには「途中まで受信した内容」を残すかは実装方針次第。
- **再試行**: Toast のメッセージで「時間をおいて再度実行してください」と案内。必要なら Toast に「再試行」アクションを付与する拡張も検討可能（react-toastify のカスタムコンポーネント等）。

---

## API エラー body のパース方針（0.3 / 質問・懸念 §6 への対応）

- **4xx（ユーザー起因）**: 解消方法が分かるメッセージを出したいため、サーバーが返した body を優先して表示する。次の順で「表示用メッセージ」を取得:
  1. `body.error?.message`（オブジェクトの場合）
  2. `body.message`
  3. `body.error`（文字列の場合）
  4. 上記がすべて無効なら「入力内容に誤りがあります。手牌やオプションを確認してください。」
- **5xx（ユーザーがどうすることもできない）**: body の内容は技術的になりがちなため、**取らずに一律**「サーバーで問題が発生しました。時間をおいて再度実行してください。」とする。
- パース処理は **`lib/mastra-client.ts` 内の 1 関数**（例: `getErrorMessageFromResponse(body, statusText, status)`）にまとめ、4xx のときだけ body 由来の文字列を返し、5xx のときは null にして呼び出し元で一律メッセージを出す、などの形にするとよい。

---

## 実装タスクとの対応

| 計画書 2.5 | 本ドキュメント |
|------------|----------------|
| 2.5.1 ネットワークエラー時にユーザー向けメッセージを表示 | §1。Toast で「接続できませんでした。時間をおいて再度実行してください。」 |
| 2.5.2 4xx/5xx で body からメッセージを読んで表示 | §2, §3。4xx は解消方法が分かるメッセージ（body 優先）、5xx は一律「時間をおいて再度実行してください」系。Toast で表示。 |
| 2.5.3 CORS エラー時にも分かりやすいメッセージ | §4。ネットワークエラーと同じ Toast 文言で「接続できませんでした。時間をおいて再度実行してください。」 |
| 2.5.4 タイムアウト時の表示 | §5。Toast で「時間がかかりすぎています。時間をおいて再度実行してください。」（タイムアウト実装時） |

**実装時の追加**: `react-toastify` を導入し、`layout.tsx` に `<ToastContainer />` を配置。`mastra-client` や `page.tsx` の catch で、分類に応じたメッセージを `toast.error(message)` に渡す。

---

## まとめ

- **表示**: すべて **react-toastify** の Toast で一律に表示する。
- **二分類**:
  - **ユーザーがどうすることもできない問題**（ネットワーク・5xx・CORS・タイムアウト・ストリーム途中失敗・その他）
    → 「時間をおいて再度実行してください」系の文言で案内。
  - **ユーザー起因の問題**（4xx）
    → サーバーから返ったメッセージをそのまま表示し、解消方法が分かるようにする。取れない場合は「入力内容を確認してください」系にフォールバック。
- **キャンセル（AbortError）**: Toast は出さず、結果末尾に「[キャンセルされました]」のみ。
- 実装時は、エラー種別を上記どちらかに分類し、分類に応じたメッセージを `toast.error(...)` に渡す。
