# 麻雀AI設計案

## 概要
牌譜を与えると、何を切るべきか（打牌選択）とその判断理由を説明してくれるAIシステム

## アーキテクチャ

### 1. レイヤー構成

```
┌─────────────────────────────────────┐
│  API層 (Mastra Agent/Tools)         │
│  - 牌譜解析エージェント              │
│  - 打牌判断エージェント              │
│  - 説明生成エージェント              │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  牌譜解析層 (majiang-analog)        │
│  - 牌譜の読み込み・解析              │
│  - 局状態の復元                      │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  判断層 (majiang-ai Player)          │
│  - 打牌選択ロジック                  │
│  - 評価情報の取得                    │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  説明生成層 (LLM)                   │
│  - 判断理由の自然言語化              │
└─────────────────────────────────────┘
```

### 2. 主要コンポーネント

#### 2.1 牌譜解析エージェント
- **役割**: 牌譜ファイルを受け取り、特定の局面を抽出
- **入力**: 牌譜ファイルパス、局番号、巡目
- **出力**: 局状態（手牌、捨て牌、場風、自風など）

#### 2.2 打牌判断エージェント
- **役割**: 局状態から最適な打牌を判断
- **入力**: 局状態
- **出力**: 
  - 推奨打牌
  - 評価情報（各候補の評価値、シャンテン数、危険度など）

#### 2.3 説明生成エージェント
- **役割**: 判断理由を自然言語で説明
- **入力**: 推奨打牌、評価情報、局状態
- **出力**: 判断理由の説明文

### 3. データフロー

```
牌譜ファイル
    ↓
[牌譜解析] → 局状態オブジェクト
    ↓
[Player初期化] → Playerインスタンス
    ↓
[select_dapai(info)] → 打牌 + 評価情報
    ↓
[説明生成] → 自然言語説明
```

### 4. 実装方針

#### 4.1 Mastraの活用
- **Agent**: 各機能をエージェントとして実装
- **Tools**: majiang-core/ai/analogの機能をツール化
- **Memory**: 判断履歴や学習データの管理

#### 4.2 既存ライブラリの活用
- `majiang-analog`: 牌譜解析
- `majiang-ai`: 打牌判断ロジック
- `majiang-core`: 基本機能（手牌操作、シャンテン計算など）

#### 4.3 説明生成のアプローチ
1. **構造化された説明**: 評価情報から自動生成
   - シャンテン数、評価値、危険度などの数値情報を説明
2. **LLMによる説明**: 評価情報をLLMに渡して自然言語化
   - より柔軟で分かりやすい説明が可能

### 5. ディレクトリ構成案

```
majiang-ai/
├── src/
│   ├── agents/
│   │   ├── paipu-analyzer.ts      # 牌譜解析エージェント
│   │   ├── dapai-selector.ts      # 打牌判断エージェント
│   │   └── explanation-generator.ts # 説明生成エージェント
│   ├── tools/
│   │   ├── majiang-tools.ts        # majiang-core/ai/analogのツール化
│   │   └── evaluation-tools.ts    # 評価計算ツール
│   ├── services/
│   │   ├── paipu-service.ts       # 牌譜解析サービス
│   │   ├── player-service.ts      # Player管理サービス
│   │   └── explanation-service.ts # 説明生成サービス
│   └── types/
│       └── majiang-types.ts       # 型定義
├── examples/
│   └── basic-usage.ts              # 使用例
└── package.json
```

### 6. 使用例（想定）

```typescript
// Mastraエージェントの使用例
const agent = new MajiangAIAgent();

// 牌譜から打牌を判断
const result = await agent.analyzePaipu({
  paipuPath: './paipu.json',
  ju: 1,        // 1局目
  xun: 5,       // 5巡目
  playerIndex: 0 // 0番目のプレーヤー
});

console.log(result.recommendedTile); // 推奨打牌
console.log(result.explanation);     // 判断理由
console.log(result.evaluation);       // 評価情報
```

### 7. 判断理由の説明内容

1. **基本情報**
   - 現在のシャンテン数
   - 推奨打牌
   - 打牌後のシャンテン数

2. **評価根拠**
   - 評価値（ev）
   - 危険度（weixian）
   - 待ち牌の種類と残り枚数

3. **戦略的判断**
   - なぜその牌を選んだか
   - 他の候補と比較した理由
   - 状況に応じた判断（リーチ時、終盤など）

### 8. 拡張性

- **複数のAI実装**: 異なるPlayer実装を選択可能
- **カスタム評価関数**: 評価ロジックのカスタマイズ
- **学習機能**: 過去の判断から学習
- **可視化**: 判断過程の可視化

## 実装の優先順位

1. **Phase 1**: 基本的な牌譜解析と打牌判断
   - majiang-analogで牌譜解析
   - majiang-aiのPlayerで打牌選択
   - 評価情報の取得

2. **Phase 2**: Mastra統合
   - エージェント化
   - ツール化
   - 基本的な説明生成

3. **Phase 3**: 高度な説明生成
   - LLMによる自然言語説明
   - 判断過程の可視化

4. **Phase 4**: 拡張機能
   - 複数AI実装の選択
   - 学習機能
   - Web UI
